[
  {
    "instance_id": "sf_bq270",
    "instruction": "What were the monthly add-to-cart and purchase conversion rates, calculated as a percentage of pageviews on product details, from January to March 2017?",
    "db_id": "GA360",
    "external_knowledge": "ga360_hits.eCommerceAction.action_type.md",
    "evidence": "Add product(s) to cart: action_type=3. Completed purchase: action_type=6. Product detail views: action_type=2. For product detail views, use: WHERE hits.ecommerceaction.action_type = '2' AND (BOOLEAN(hits.product.isImpression) IS NULL OR BOOLEAN(hits.product.isImpression) == FALSE).",
    "table": [
      "GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20160801"
    ],
    "col": {
      "GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20160801": []
    },
    "sample_history": {
      "0": {
        "GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20160801": []
      }
    },
    "temp_SQL": "WITH combined_tables AS (\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170101\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170102\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170103\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170104\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170105\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170106\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170107\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170108\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170109\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170110\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170111\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170112\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170113\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170114\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170115\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170116\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170117\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170118\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170119\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170120\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170121\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170122\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170123\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170124\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170125\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170126\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170127\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170128\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170129\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170130\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170131\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170201\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170202\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170203\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170204\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170205\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170206\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170207\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170208\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170209\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170210\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170211\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170212\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170213\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170214\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170215\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170216\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170217\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170218\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170219\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170220\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170221\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170222\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170223\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170224\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170225\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170226\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170227\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170228\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170301\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170302\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170303\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170304\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170305\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170306\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170307\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170308\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170309\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170310\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170311\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170312\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170313\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170314\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170315\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170316\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170317\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170318\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170319\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170320\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170321\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170322\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170323\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170324\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170325\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170326\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170327\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170328\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170329\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170330\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170331\"\n),\nflattened_data AS (\n  SELECT\n    SUBSTR(t.\"date\", 1, 6) AS \"month\",\n    f.value AS hit\n  FROM combined_tables t,\n  LATERAL FLATTEN(input => t.\"hits\") f\n),\nmonthly_counts AS (\n  SELECT\n    \"month\",\n    SUM(CASE WHEN hit:\"eCommerceAction\".action_type::STRING = '2' \n            AND (hit:product.isImpression::STRING IS NULL\n                 OR hit:product.isImpression::STRING = 'false') \n            THEN 1 ELSE 0 END) AS \"product_views\",\n    SUM(CASE WHEN hit:\"eCommerceAction\".action_type::STRING = '3' THEN 1 ELSE 0 END) AS \"add_to_carts\",\n    SUM(CASE WHEN hit:\"eCommerceAction\".action_type::STRING = '6' THEN 1 ELSE 0 END) AS \"purchases\"\n  FROM flattened_data\n  GROUP BY \"month\"\n)\nSELECT\n  \"month\",\n  \"product_views\",\n  \"add_to_carts\",\n  \"purchases\",\n  ROUND((\"add_to_carts\" * 100.0) / NULLIF(\"product_views\", 0), 4) AS \"add_to_cart_cr\",\n  ROUND((\"purchases\" * 100.0) / NULLIF(\"product_views\", 0), 4) AS \"purchase_cr\"\nFROM monthly_counts\nORDER BY \"month\";",
    "final_SQL": "WITH combined_tables AS (\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170101\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170102\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170103\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170104\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170105\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170106\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170107\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170108\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170109\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170110\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170111\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170112\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170113\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170114\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170115\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170116\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170117\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170118\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170119\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170120\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170121\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170122\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170123\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170124\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170125\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170126\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170127\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170128\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170129\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170130\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170131\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170201\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170202\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170203\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170204\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170205\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170206\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170207\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170208\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170209\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170210\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170211\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170212\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170213\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170214\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170215\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170216\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170217\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170218\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170219\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170220\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170221\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170222\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170223\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170224\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170225\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170226\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170227\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170228\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170301\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170302\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170303\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170304\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170305\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170306\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170307\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170308\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170309\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170310\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170311\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170312\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170313\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170314\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170315\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170316\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170317\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170318\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170319\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170320\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170321\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170322\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170323\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170324\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170325\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170326\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170327\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170328\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170329\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170330\"\n  UNION ALL\n  SELECT \"date\", \"hits\" FROM \"GA360\".\"GOOGLE_ANALYTICS_SAMPLE\".\"GA_SESSIONS_20170331\"\n),\nflattened_data AS (\n  SELECT\n    SUBSTR(t.\"date\", 1, 6) AS \"month\",\n    f.value AS hit\n  FROM combined_tables t,\n  LATERAL FLATTEN(input => t.\"hits\") f\n),\nmonthly_counts AS (\n  SELECT\n    \"month\",\n    SUM(CASE WHEN hit:\"eCommerceAction\".action_type::STRING = '2' \n            AND (hit:product.isImpression::STRING IS NULL\n                 OR hit:product.isImpression::STRING = 'false') \n            THEN 1 ELSE 0 END) AS \"product_views\",\n    SUM(CASE WHEN hit:\"eCommerceAction\".action_type::STRING = '3' THEN 1 ELSE 0 END) AS \"add_to_carts\",\n    SUM(CASE WHEN hit:\"eCommerceAction\".action_type::STRING = '6' THEN 1 ELSE 0 END) AS \"purchases\"\n  FROM flattened_data\n  GROUP BY \"month\"\n)\nSELECT\n  \"month\",\n  \"product_views\",\n  \"add_to_carts\",\n  \"purchases\",\n  ROUND((\"add_to_carts\" * 100.0) / NULLIF(\"product_views\", 0), 4) AS \"add_to_cart_cr\",\n  ROUND((\"purchases\" * 100.0) / NULLIF(\"product_views\", 0), 4) AS \"purchase_cr\"\nFROM monthly_counts\nORDER BY \"month\";",
    "Step_counter": 5
  }
]